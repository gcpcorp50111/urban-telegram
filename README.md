# 城市步行可達性與路徑連通分析工具

此分析工具用於評估城市設計方案前後的步行可達性變化。結合了電腦視覺與路徑演算法，模擬行人如何穿越斑馬線並擴散至周邊街廓。

線上版本:https://gcpcorp50111.github.io/urban-telegram/ (跑起來較慢)
* 下載`site_existing.jpg` 以及 `site_design.jpg` ，進入網站後於左側選取此兩個檔案。
* 使用了**scikit-image**，以Python編程語言的開源圖像處理庫 https://github.com/scikit-image/scikit-image
## 調整參數
所有可調整的參數都集中在程式碼最上方的 `class USER_CONFIG` 區域。

### 1. 檔案與位置
* **`FILE_EXISTING`**: 設計前(現況)的底圖檔名。(`site_existing.jpg`)
* **`FILE_PROPOSED`**: 設計後(或是不同方案)的底圖檔名。(`site_design.jpg`)

    * 兩張圖片需為相同尺寸，可使用repository裡的`site_existing.psd`進行修改。並轉存為`site_design.jpg`   
    * 若新增了天橋、廣場或地下道，則在底圖上標示成綠色廊道(可行走區域)。
    
* **`START_POINT`**: 起點座標 `(Y, X)`。
    * 起點應為可通行區域(範例圖中綠色)，熱力圖將由此擴張。
    * 注意Y是垂直軸(由上往下算)，X是水平軸(由左往右算)。
    * 使用小畫家或Photoshop開啟圖片，滑鼠移到起點，查看資訊欄的像素座標。如下圖為`(500, 1100)`
    * ![Photoshop內尋找座標](https://img1.pixhost.to/images/11411/680608162__2026_01_06_01_48_48_652.png)

### 2. 顏色定義 (RGB)
根據需分析的圖片，填入圖片中對應顏色的RGB數值。
* **`WALL` (黑色)**: 障礙物與建築物。
* **`ROAD` (白色)**: 一般道路(程式會自動篩選出過寬的車道並封鎖)。
* **`PLAZA` (綠色)**: 絕對安全的可行走區域(人行道、廣場)。
* **`PORTAL` (紅色)**: 斑馬線(如傳送門般繼承步行時間並加上等待通行的懲罰時間)。
* **`COLOR_TOLERANCE`**: 顏色容許誤差。預設 `40`。如果圖片有雜訊或顏色不純，可調高此數值。
![site_existing範例圖片](https://img1.pixhost.to/images/11412/680613415_site_existing.jpg)
### 3. 分析參數
* **`PIXELS_PER_MINUTE`**: 步行速度換算。(圖面1分鐘步行距離的像素長度)。
* **`METERS_PER_PIXEL`**: 比例尺。(真實距離/圖面像素)
* **`MAX_VISUAL_TIME`**: 熱力圖最大顯示分鐘數(與下列數列最大值同)
* **`LEVELS`**: 等時圈的分鐘數設定，例如[1, 3, 5, 8, 10, 15] 代表會在這些時間點畫白線。
* **`PENALTY_BASE`**: 過馬路的起跳等待時間(分鐘)。
* **`PENALTY_FACTOR`**: 斑馬線長度權重。等待時間=Base+(長度公尺*Factor)


## 結構與邏輯解釋

1.  **顏色分類**
    * 將圖片轉為電腦看得懂的矩陣,消除圖片壓縮產生的細微雜訊。
2.  **路寬篩選縫合**
    * 針對馬路區域，偵測寬度大於6公尺的區域並視為車道封鎖，只保留窄巷。同時解決斑馬線與人行道沒有完美連接的問題。距離斑馬線4px內的可行走區域建立橋梁。
3.  **偵測有效起點**
    * 避免起點落在「看起來像路但其實是孤島」的區域（如被車道包圍的安全島）。程式會檢查連通性，剔除誤判區域。
4.  **找出與起點相連的門並模擬分支**
    * 模擬使用者在起點面臨的選擇。程式會一條條分析與起點相連的每一條斑馬線(關閉其他，但可透過繞路回頭經過斑馬線)，計算該路徑的擴散範圍。
5.  **生成最終疊圖**
    * 所有分支情境的結果疊加，取最小值，代表該區域的最佳可達性。

## 如何解讀輸出圖表

### 1. 單一方案資料夾 (`folder_existing`, `folder_proposed`)
* **`Branch_Portal_XX.png`**:一次只走一條斑馬線離開起點能走到哪裡？這能檢視單一路徑的服務範圍。
![分支服務範圍範例圖](https://img1.pixhost.to/images/11412/680614192_branch_portal_07.png)
* **`FINAL_Stacked.png`**:該方案的最終綜合熱力圖。(藍/綠):步行時間短，可達性高。(黃/紅):步行時間長，可達性低。
![最小時間疊圖範例圖](https://img1.pixhost.to/images/11412/680614247_final_stacked.png)

### 2. 設計效益比較圖 (`COMPARISON_Diff_Map.png`)
這張圖在最外層，將現況與設計後兩張圖相減。
* 藍色區域:顏色越深代表省下的時間越多。
* 金色區域:代表原本該處走不到，設計介入後變成可達。
* 紅色區域:通常不應出現，除非設計移除了捷徑。
![設計效益範例圖](https://img1.pixhost.to/images/11412/680614645_comparison_diff_map.png)
## 錯誤排查

檢查TERMINAL的錯誤訊息：

1.  錯誤: 找不到檔案。
    * 圖片檔名不對，或是圖片沒有放在程式同一層資料夾。
2.  起點落在無效區域，請調整起點位置後重試。
    *  `START_POINT` 座標落在了建築內部或大馬路上。
    * 調整座標並確保起點落在圖上可行走區域內。
3.  ValueError: minvalue must be less than...
    * 起點是孤島。雖然起點在綠地上，但周圍沒有任何斑馬線或路徑可以走出去，導致熱力圖全空。
    * 檢查圖片，確認起點周圍是否有紅色斑馬線？或調整 `COLOR_TOLERANCE` 讓程式更容易抓到路徑。
4.  熱力圖溢出到馬路上
    * 馬路的判定過於寬鬆。
    * 檢查 `ROAD` 的 RGB 設定是否正確，或確認圖片本身是否乾淨（不要有雜色）。
